{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "config": {
            "basics": {
                "description": "Deploy the Policing Assistant solution with automatic resource naming, random suffixes to prevent conflicts, and pre-configured startup commands for optimal performance.",
                "location": {
                    "visible": true,
                    "allowedValues": [
                        "uksouth", 
                        "ukwest",
                        "westeurope",
                        "northeurope"
                    ]
                }
            }
        },
        "basics": [
            {
                "name": "forceInfo",
                "type": "Microsoft.Common.Section", 
                "label": "Police Force Configuration",
                "elements": [
                    {
                        "name": "forceCode",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Police Force Code",
                        "defaultValue": "btp",
                        "toolTip": "Enter your 2-3 character police force code (e.g., 'btp', 'met', 'gmp'). Must be lowercase letters only.",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-z]{2,3}$",
                            "validationMessage": "Force code must be 2-3 lowercase letters only (e.g., 'btp', 'met', 'gmp')."
                        }
                    },
                    {
                        "name": "environment",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Environment", 
                        "defaultValue": "prod",
                        "toolTip": "Select the deployment environment",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Production",
                                    "value": "prod"
                                },
                                {
                                    "label": "Development", 
                                    "value": "dev"
                                },
                                {
                                    "label": "Test",
                                    "value": "test"
                                }
                            ],
                            "required": true
                        }
                    },
                    {
                        "name": "instanceNumber",
                        "type": "Microsoft.Common.TextBox", 
                        "label": "Instance Number",
                        "defaultValue": "01",
                        "toolTip": "Instance number for this deployment (01, 02, etc.)",
                        "constraints": {
                            "required": true,
                            "regex": "^[0-9]{2}$",
                            "validationMessage": "Instance number must be exactly 2 digits (01, 02, 03, etc.)."
                        }
                    }
                ]
            },
            {
                "name": "azureAdInfo",
                "type": "Microsoft.Common.Section",
                "label": "Azure AD App Registration Configuration",
                "elements": [
                    {
                        "name": "createAzureAdApp",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Create Azure AD App Registration",
                        "defaultValue": "Yes",
                        "toolTip": "Whether to create an Azure AD app registration for authentication. Recommended for first-time deployments.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "✅ YES - Create new app registration (RECOMMENDED for first deployment)",
                                    "value": "Yes"
                                },
                                {
                                    "label": "No - I'll use existing app registration",
                                    "value": "No"
                                }
                            ],
                            "required": true
                        }
                    },
                    {
                        "name": "appDisplayName",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Application Display Name",
                        "defaultValue": "[concat('CoPPA-', toUpper(basics('forceInfo').forceCode), '-', toUpper(basics('forceInfo').environment))]",
                        "toolTip": "The display name for your Azure AD app registration. This will be visible in the Azure Portal and to users during authentication.",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
                        "constraints": {
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
                            "regex": "^[a-zA-Z0-9\\s\\-_\\.]{1,120}$",
                            "validationMessage": "App name must be 1-120 characters using letters, numbers, spaces, hyphens, underscores, or periods."
                        }
                    },
                    {
                        "name": "supportedAccountTypes",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Supported Account Types",
                        "defaultValue": "AzureADMyOrg",
                        "toolTip": "Who can sign in to this application. Single tenant is recommended for police force applications.",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "✅ Single tenant only (RECOMMENDED for police force security)",
                                    "value": "AzureADMyOrg"
                                },
                                {
                                    "label": "Multi-tenant (any organizational directory)",
                                    "value": "AzureADMultipleOrgs"
                                },
                                {
                                    "label": "Multi-tenant + personal accounts (not recommended for police use)",
                                    "value": "AzureADandPersonalMicrosoftAccount"
                                }
                            ],
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]"
                        }
                    },
                    {
                        "name": "enableImplicitFlow",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Enable Implicit Flow for ID Tokens",
                        "defaultValue": "Yes",
                        "toolTip": "Enable implicit grant flow for ID tokens. Required for web applications using OpenID Connect authentication.",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "✅ YES - Enable ID tokens (REQUIRED for CoPPA authentication)",
                                    "value": "Yes"
                                },
                                {
                                    "label": "❌ No - Disable implicit flow (will break authentication)",
                                    "value": "No"
                                }
                            ],
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]"
                        }
                    },
                    {
                        "name": "enableUserRead",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Grant Microsoft Graph: User.Read Permission",
                        "defaultValue": "Yes",
                        "toolTip": "Allow the application to read user profile information. Required for user authentication and profile display.",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "✅ YES - Grant User.Read permission (REQUIRED for login)",
                                    "value": "Yes"
                                },
                                {
                                    "label": "❌ No - Skip this permission (will break login)",
                                    "value": "No"
                                }
                            ],
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]"
                        }
                    },
                    {
                        "name": "clientSecretDescription",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Client Secret Description",
                        "defaultValue": "CoPPA Application Secret",
                        "toolTip": "Description for the client secret to help identify it in the Azure Portal.",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
                        "constraints": {
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
                            "regex": "^[a-zA-Z0-9\\s\\-_\\.]{1,200}$",
                            "validationMessage": "Description must be 1-200 characters using letters, numbers, spaces, hyphens, underscores, or periods."
                        }
                    },
                    {
                        "name": "clientSecretExpiry",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Client Secret Expiry Period",
                        "defaultValue": "24",
                        "toolTip": "How long the client secret should be valid. Shorter periods are more secure but require more frequent renewal.",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "6 months",
                                    "value": "6"
                                },
                                {
                                    "label": "12 months", 
                                    "value": "12"
                                },
                                {
                                    "label": "24 months (recommended)",
                                    "value": "24"
                                }
                            ],
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]"
                        }
                    },
                    {
                        "name": "userAssignmentRequired",
                        "type": "Microsoft.Common.DropDown",
                        "label": "User Assignment Required",
                        "defaultValue": "Yes",
                        "toolTip": "🛡️ POLICE SECURITY: 'Yes' = RECOMMENDED for police applications - enables proper RBAC control and user assignment. 'No' = Less secure, allows all users in your organization to access CoPPA immediately without assignment control.",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "✅ YES - Only assigned users can access (RECOMMENDED for police RBAC security)",
                                    "value": "Yes"
                                },
                                {
                                    "label": "⚠️ NO - All authenticated users can access (less secure, not recommended for police use)",
                                    "value": "No"
                                }
                            ],
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]"
                        }
                    },
                    {
                        "name": "existingClientId",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Existing App Client ID",
                        "toolTip": "The Client ID (Application ID) of your existing Azure AD app registration",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'No')]",
                        "constraints": {
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'No')]",
                            "regex": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
                            "validationMessage": "Must be a valid GUID format (e.g., 12345678-1234-1234-1234-123456789012)"
                        }
                    },
                    {
                        "name": "existingClientSecret",
                        "type": "Microsoft.Common.PasswordBox",
                        "label": {
                            "password": "Existing App Client Secret",
                            "confirmPassword": "Confirm Client Secret"
                        },
                        "toolTip": "The Client Secret of your existing Azure AD app registration",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'No')]",
                        "constraints": {
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'No')]"
                        }
                    },
                    {
                        "name": "existingTenantId",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Tenant ID",
                        "defaultValue": "[subscription().tenantId]",
                        "toolTip": "Your Azure AD Tenant ID (Directory ID). This is auto-populated from your current context.",
                        "visible": "[equals(basics('azureAdInfo').createAzureAdApp, 'No')]",
                        "constraints": {
                            "required": "[equals(basics('azureAdInfo').createAzureAdApp, 'No')]",
                            "regex": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
                            "validationMessage": "Must be a valid GUID format (e.g., 12345678-1234-1234-1234-123456789012)"
                        }
                    }
                ]
            }
        ],
        "steps": [
            {
                "name": "uiConfig",
                "label": "UI Configuration",
                "elements": [
                    {
                        "name": "uiCustomization",
                        "type": "Microsoft.Common.Section",
                        "label": "User Interface Customization",
                        "elements": [
                            {
                                "name": "feedbackEmail",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Feedback Email (Optional)",
                                "placeholder": "feedback@your-force.police.uk",
                                "toolTip": "Email address where user feedback will be sent. Leave empty if you don't want a feedback option.",
                                "constraints": {
                                    "required": false,
                                    "regex": "^$|^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
                                    "validationMessage": "Must be a valid email address or leave empty."
                                }
                            },
                            {
                                "name": "findOutMoreLink",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Find Out More Link (Optional)",
                                "placeholder": "https://your-force.police.uk/coppa-info",
                                "toolTip": "URL for the 'Find Out More' link in the application. Leave empty if you don't want this link.",
                                "constraints": {
                                    "required": false,
                                    "regex": "^$|^https?://[\\w\\-]+(\\.[\\w\\-]+)+([\\w\\-\\.,@?^=%&:/~\\+#]*[\\w\\-\\@?^=%&/~\\+#])?$",
                                    "validationMessage": "Must be a valid URL (starting with http:// or https://) or leave empty."
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "appConfig",
                "label": "Application Configuration",
                "elements": [
                    {
                        "name": "startupConfig",
                        "type": "Microsoft.Common.Section",
                        "label": "Application Startup Configuration",
                        "elements": [
                            {
                                "name": "startupCommand",
                                "type": "Microsoft.Common.TextBox",
                                "label": "App Startup Command",
                                "defaultValue": "python -m gunicorn app:app",
                                "toolTip": "The command used to start the application. This is pre-configured for optimal performance with Gunicorn.",
                                "constraints": {
                                    "required": true,
                                    "validationMessage": "Startup command is required."
                                }
                            },
                            {
                                "name": "deploymentSource",
                                "type": "Microsoft.Common.DropDown",
                                "label": "Deployment Center Source",
                                "defaultValue": "External Git",
                                "toolTip": "The source type for application deployment. External Git is recommended for CoPPA.",
                                "constraints": {
                                    "allowedValues": [
                                        {
                                            "label": "External Git",
                                            "value": "External Git"
                                        },
                                        {
                                            "label": "GitHub",
                                            "value": "GitHub"
                                        },
                                        {
                                            "label": "Local Git",
                                            "value": "Local Git"
                                        }
                                    ],
                                    "required": true
                                }
                            },
                            {
                                "name": "repositoryType",
                                "type": "Microsoft.Common.DropDown",
                                "label": "Repository Type",
                                "defaultValue": "Public",
                                "toolTip": "Whether the repository is public or private. The CoPPA repository is public.",
                                "constraints": {
                                    "allowedValues": [
                                        {
                                            "label": "Public",
                                            "value": "Public"
                                        },
                                        {
                                            "label": "Private",
                                            "value": "Private"
                                        }
                                    ],
                                    "required": true
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "gitConfig",
                "label": "Git Deployment Configuration",
                "elements": [
                    {
                        "name": "deploymentConfig",
                        "type": "Microsoft.Common.Section",
                        "label": "Source Code Deployment",
                        "elements": [
                            {
                                "name": "enableGitDeployment",
                                "type": "Microsoft.Common.DropDown",
                                "label": "Enable Automatic Git Deployment",
                                "defaultValue": "Yes",
                                "toolTip": "Automatically configure Git deployment from the CoPPA repository. This eliminates manual setup in the Deployment Center.",
                                "constraints": {
                                    "allowedValues": [
                                        {
                                            "label": "Yes - Configure automatic deployment",
                                            "value": "Yes"
                                        },
                                        {
                                            "label": "No - I'll configure manually",
                                            "value": "No"
                                        }
                                    ],
                                    "required": true
                                }
                            },
                            {
                                "name": "gitRepositoryUrl",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Git Repository URL",
                                "defaultValue": "https://github.com/Russ-Holloway/CoPPA.git",
                                "toolTip": "The URL of the Git repository to deploy from. Default is the official CoPPA repository.",
                                "visible": "[equals(steps('gitConfig').deploymentConfig.enableGitDeployment, 'Yes')]",
                                "constraints": {
                                    "required": "[equals(steps('gitConfig').deploymentConfig.enableGitDeployment, 'Yes')]",
                                    "regex": "^https://.*\\.git$",
                                    "validationMessage": "Must be a valid Git repository URL ending with .git"
                                }
                            },
                            {
                                "name": "gitBranch",
                                "type": "Microsoft.Common.DropDown",
                                "label": "Git Branch",
                                "defaultValue": "main",
                                "toolTip": "The branch to deploy from. Use 'main' for production releases.",
                                "visible": "[equals(steps('gitConfig').deploymentConfig.enableGitDeployment, 'Yes')]",
                                "constraints": {
                                    "allowedValues": [
                                        {
                                            "label": "main (recommended for production)",
                                            "value": "main"
                                        },
                                        {
                                            "label": "develop",
                                            "value": "develop"
                                        },
                                        {
                                            "label": "Deployment-Template (testing deployment automation)",
                                            "value": "Deployment-Template"
                                        },
                                        {
                                            "label": "feature/latest",
                                            "value": "Feature-Deployment-Automation"
                                        }
                                    ],
                                    "required": "[equals(steps('gitConfig').deploymentConfig.enableGitDeployment, 'Yes')]"
                                }
                            }
                        ]
                    }
                ]
            }
        ],
        "outputs": {
            "ForceCode": "[basics('forceInfo').forceCode]",
            "EnvironmentSuffix": "[basics('forceInfo').environment]", 
            "InstanceNumber": "[basics('forceInfo').instanceNumber]",
            "CreateAzureAdAppRegistration": "[equals(basics('azureAdInfo').createAzureAdApp, 'Yes')]",
            "AzureAdAppDisplayName": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'Yes'), basics('azureAdInfo').appDisplayName, '')]",
            "AzureAdSupportedAccountTypes": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'Yes'), basics('azureAdInfo').supportedAccountTypes, '')]",
            "AzureAdEnableImplicitFlow": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'Yes'), equals(basics('azureAdInfo').enableImplicitFlow, 'Yes'), false)]",
            "AzureAdEnableUserRead": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'Yes'), equals(basics('azureAdInfo').enableUserRead, 'Yes'), false)]",
            "AzureAdClientSecretDescription": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'Yes'), basics('azureAdInfo').clientSecretDescription, '')]",
            "AzureAdClientSecretExpiry": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'Yes'), basics('azureAdInfo').clientSecretExpiry, '24')]",
            "AzureAdUserAssignmentRequired": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'Yes'), equals(basics('azureAdInfo').userAssignmentRequired, 'Yes'), false)]",
            "ExistingAzureAdClientId": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'No'), basics('azureAdInfo').existingClientId, '')]",
            "ExistingAzureAdClientSecret": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'No'), basics('azureAdInfo').existingClientSecret, '')]",
            "ExistingAzureAdTenantId": "[if(equals(basics('azureAdInfo').createAzureAdApp, 'No'), basics('azureAdInfo').existingTenantId, subscription().tenantId)]",
            "UIFeedbackEmail": "[steps('uiConfig').uiCustomization.feedbackEmail]",
            "UIFindOutMoreLink": "[steps('uiConfig').uiCustomization.findOutMoreLink]",
            "AppStartupCommand": "[steps('appConfig').startupConfig.startupCommand]",
            "DeploymentSource": "[steps('appConfig').startupConfig.deploymentSource]",
            "RepositoryType": "[steps('appConfig').startupConfig.repositoryType]",
            "EnableGitDeployment": "[equals(steps('gitConfig').deploymentConfig.enableGitDeployment, 'Yes')]",
            "GitRepositoryUrl": "[steps('gitConfig').deploymentConfig.gitRepositoryUrl]",
            "GitBranch": "[steps('gitConfig').deploymentConfig.gitBranch]"
        }
    }
}
