{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "config": {
            "basics": {
                "description": "**CoPA (Conversational Police Assistant)** - AI-powered assistant for UK Police Forces.\n\nThis deployment will create a comprehensive AI assistant with Azure OpenAI, Cognitive Search, and secure authentication.\n\n⚠️ **Important**: You will need to create an Azure AD App Registration as part of this setup process.",
                "subscription": {
                    "constraints": {
                        "validations": [
                            {
                                "isValid": "[not(equals(subscription().subscriptionId, 'demo-subscription-id'))]",
                                "message": "Please select a valid Azure subscription."
                            }
                        ]
                    }
                },
                "resourceGroup": {
                    "constraints": {
                        "validations": [
                            {
                                "isValid": "[matches(resourceGroup().name, '^rg-[a-z]{2,3}-copa-(prod|dev|test)-[0-9]{2}$')]",
                                "message": "Resource group name must follow the pattern: rg-{ForceCode}-copa-{Environment}-{Instance} (e.g., rg-met-copa-prod-01)"
                            }
                        ]
                    }
                },
                "location": {
                    "visible": true,
                    "allowedValues": [
                        "uksouth",
                        "ukwest",
                        "westeurope",
                        "northeurope",
                        "eastus",
                        "eastus2",
                        "westus2"
                    ]
                }
            }
        },
        "basics": [
            {
                "name": "forceInfo",
                "type": "Microsoft.Common.Section",
                "label": "Police Force Configuration",
                "elements": [
                    {
                        "name": "forceCodeInfo",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": true,
                        "options": {
                            "icon": "Info",
                            "text": "The Police Force Code will be automatically extracted from your resource group name. Ensure your resource group follows the naming convention: rg-{ForceCode}-copa-{Environment}-{Instance}"
                        }
                    }
                ]
            }
        ],
        "steps": [
            {
                "name": "azureAdPreReqs",
                "label": "Azure AD Prerequisites",
                "elements": [
                    {
                        "name": "azureAdInstructions",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": true,
                        "options": {
                            "icon": "Warning",
                            "text": "**Before continuing, you need to create an Azure AD App Registration.** This is required for secure authentication to your CoPA application.",
                            "uri": "https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app"
                        }
                    },
                    {
                        "name": "createAppSteps",
                        "type": "Microsoft.Common.Section",
                        "label": "Step-by-Step Azure AD App Registration",
                        "elements": [
                            {
                                "name": "step1",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": true,
                                "options": {
                                    "icon": "None",
                                    "text": "**Step 1:** Click the button below to open Azure AD App Registrations in a new tab:",
                                    "uri": "https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade"
                                }
                            },
                            {
                                "name": "step2Text",
                                "type": "Microsoft.Common.TextBlock",
                                "visible": true,
                                "options": {
                                    "text": "**Step 2:** Click 'New registration' and fill in:\n• **Name**: CoPA-[YourForceCode]-prod (e.g., CoPA-MET-prod)\n• **Supported account types**: Accounts in this organizational directory only\n• **Redirect URI**: Leave blank for now (we'll configure this automatically)"
                                }
                            },
                            {
                                "name": "step3Text",
                                "type": "Microsoft.Common.TextBlock",
                                "visible": true,
                                "options": {
                                    "text": "**Step 3:** After creating the app:\n• Copy the **Application (client) ID** from the Overview page\n• Go to 'Certificates & secrets' → 'New client secret'\n• Create a secret with 24 months expiry\n• Copy the **Secret Value** (you won't see it again!)"
                                }
                            },
                            {
                                "name": "step4Text",
                                "type": "Microsoft.Common.TextBlock",
                                "visible": true,
                                "options": {
                                    "text": "**Step 4:** Note your **Tenant (Directory) ID** from the Overview page\n\n**Step 5:** Enter the copied values in the fields below:"
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "azureAdConfig",
                "label": "Azure AD Configuration",
                "elements": [
                    {
                        "name": "enableAzureAd",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Enable Azure AD Authentication",
                        "toolTip": "Uncheck this if you want to configure authentication manually after deployment"
                    },
                    {
                        "name": "azureAdSettings",
                        "type": "Microsoft.Common.Section",
                        "label": "Azure AD Application Details",
                        "visible": "[steps('azureAdConfig').enableAzureAd]",
                        "elements": [
                            {
                                "name": "clientId",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Application (Client) ID",
                                "placeholder": "e.g., 12345678-1234-1234-1234-123456789012",
                                "toolTip": "The Application (Client) ID from your Azure AD App Registration Overview page",
                                "constraints": {
                                    "required": true,
                                    "regex": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
                                    "validationMessage": "Please enter a valid GUID format (e.g., 12345678-1234-1234-1234-123456789012)"
                                }
                            },
                            {
                                "name": "clientSecret",
                                "type": "Microsoft.Common.PasswordBox",
                                "label": {
                                    "password": "Client Secret",
                                    "confirmPassword": "Confirm Client Secret"
                                },
                                "toolTip": "The client secret value from your Azure AD App Registration (NOT the Secret ID)",
                                "constraints": {
                                    "required": true,
                                    "regex": "^[A-Za-z0-9~._-]{1,255}$",
                                    "validationMessage": "Invalid client secret format"
                                },
                                "options": {
                                    "hideConfirmation": false
                                }
                            },
                            {
                                "name": "tenantId",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Tenant (Directory) ID",
                                "placeholder": "e.g., 87654321-4321-4321-4321-210987654321",
                                "toolTip": "The Tenant (Directory) ID from your Azure AD App Registration Overview page",
                                "defaultValue": "[subscription().tenantId]",
                                "constraints": {
                                    "required": true,
                                    "regex": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
                                    "validationMessage": "Please enter a valid GUID format (e.g., 87654321-4321-4321-4321-210987654321)"
                                }
                            },
                            {
                                "name": "appDisplayName",
                                "type": "Microsoft.Common.TextBox",
                                "label": "App Registration Display Name",
                                "defaultValue": "[concat('CoPA-', take(split(resourceGroup().name, '-')[1], 3), '-prod')]",
                                "toolTip": "This should match the name you used when creating the Azure AD App Registration",
                                "constraints": {
                                    "required": true,
                                    "regex": "^[a-zA-Z0-9-_. ]{3,120}$",
                                    "validationMessage": "Display name must be 3-120 characters and contain only letters, numbers, spaces, hyphens, underscores, and periods"
                                }
                            }
                        ]
                    },
                    {
                        "name": "authValidation",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": "[steps('azureAdConfig').enableAzureAd]",
                        "options": {
                            "icon": "Info",
                            "text": "After deployment completes, the redirect URIs will be automatically configured in your Azure AD App Registration."
                        }
                    }
                ]
            },
            {
                "name": "appConfig",
                "label": "Application Configuration",
                "elements": [
                    {
                        "name": "openAiConfig",
                        "type": "Microsoft.Common.Section",
                        "label": "Azure OpenAI Configuration",
                        "elements": [
                            {
                                "name": "openAiModel",
                                "type": "Microsoft.Common.DropDown",
                                "label": "OpenAI Model",
                                "defaultValue": "GPT-4o",
                                "toolTip": "Select the OpenAI model to deploy",
                                "constraints": {
                                    "allowedValues": [
                                        {
                                            "label": "GPT-4o",
                                            "value": "gpt-4o"
                                        },
                                        {
                                            "label": "GPT-4o Mini",
                                            "value": "gpt-4o-mini"
                                        },
                                        {
                                            "label": "GPT-4 Turbo",
                                            "value": "gpt-4-turbo"
                                        }
                                    ],
                                    "required": true
                                }
                            },
                            {
                                "name": "embeddingModel",
                                "type": "Microsoft.Common.DropDown",
                                "label": "Embedding Model",
                                "defaultValue": "text-embedding-3-small",
                                "toolTip": "Select the embedding model for document processing",
                                "constraints": {
                                    "allowedValues": [
                                        {
                                            "label": "Text Embedding 3 Small",
                                            "value": "text-embedding-3-small"
                                        },
                                        {
                                            "label": "Text Embedding 3 Large", 
                                            "value": "text-embedding-3-large"
                                        },
                                        {
                                            "label": "Text Embedding ADA 002",
                                            "value": "text-embedding-ada-002"
                                        }
                                    ],
                                    "required": true
                                }
                            }
                        ]
                    },
                    {
                        "name": "uiConfig",
                        "type": "Microsoft.Common.Section",
                        "label": "User Interface Configuration",
                        "elements": [
                            {
                                "name": "feedbackEmail",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Feedback Email Address",
                                "placeholder": "feedback@yourforce.police.uk",
                                "toolTip": "Email address where user feedback will be sent (optional)",
                                "constraints": {
                                    "required": false,
                                    "regex": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
                                    "validationMessage": "Please enter a valid email address"
                                }
                            },
                            {
                                "name": "findOutMoreLink",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Find Out More Link",
                                "placeholder": "https://yourforce.police.uk/copa-info",
                                "toolTip": "URL for additional information about CoPA (optional)",
                                "constraints": {
                                    "required": false,
                                    "regex": "^https?://[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}(/.*)?$",
                                    "validationMessage": "Please enter a valid HTTP or HTTPS URL"
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "deployment",
                "label": "Deployment Options",
                "elements": [
                    {
                        "name": "gitConfig",
                        "type": "Microsoft.Common.Section",
                        "label": "Source Code Deployment",
                        "elements": [
                            {
                                "name": "enableGitDeployment",
                                "type": "Microsoft.Common.CheckBox",
                                "label": "Enable automatic deployment from GitHub",
                                "toolTip": "Automatically deploy the latest CoPA source code from GitHub"
                            },
                            {
                                "name": "repositoryUrl",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Git Repository URL",
                                "defaultValue": "https://github.com/Russ-Holloway/CoPA.git",
                                "toolTip": "GitHub repository URL for CoPA source code",
                                "visible": "[steps('deployment').gitConfig.enableGitDeployment]",
                                "constraints": {
                                    "required": "[steps('deployment').gitConfig.enableGitDeployment]",
                                    "regex": "^https://github\\.com/[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+(\\.git)?$",
                                    "validationMessage": "Please enter a valid GitHub repository URL"
                                }
                            },
                            {
                                "name": "gitBranch",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Git Branch",
                                "defaultValue": "main",
                                "toolTip": "Git branch to deploy from",
                                "visible": "[steps('deployment').gitConfig.enableGitDeployment]",
                                "constraints": {
                                    "required": "[steps('deployment').gitConfig.enableGitDeployment]",
                                    "regex": "^[a-zA-Z0-9._/-]+$",
                                    "validationMessage": "Please enter a valid git branch name"
                                }
                            }
                        ]
                    }
                ]
            }
        ],
        "outputs": {
            "ForceCode": "[take(split(resourceGroup().name, '-')[1], 3)]",
            "EnvironmentSuffix": "[split(resourceGroup().name, '-')[3]]",
            "InstanceNumber": "[split(resourceGroup().name, '-')[4]]",
            "ResourceGroupName": "[resourceGroup().name]",
            "AzureOpenAIModelName": "[steps('appConfig').openAiConfig.openAiModel]",
            "AzureOpenAIEmbeddingName": "[steps('appConfig').openAiConfig.embeddingModel]",
            "CreateAzureAdAppRegistration": "[steps('azureAdConfig').enableAzureAd]",
            "AzureAdAppDisplayName": "[if(steps('azureAdConfig').enableAzureAd, steps('azureAdConfig').azureAdSettings.appDisplayName, '')]",
            "AzureAdClientId": "[if(steps('azureAdConfig').enableAzureAd, steps('azureAdConfig').azureAdSettings.clientId, '')]",
            "AzureAdClientSecret": "[if(steps('azureAdConfig').enableAzureAd, steps('azureAdConfig').azureAdSettings.clientSecret, '')]",
            "AzureAdTenantId": "[if(steps('azureAdConfig').enableAzureAd, steps('azureAdConfig').azureAdSettings.tenantId, subscription().tenantId)]",
            "UIFeedbackEmail": "[steps('appConfig').uiConfig.feedbackEmail]",
            "UIFindOutMoreLink": "[steps('appConfig').uiConfig.findOutMoreLink]",
            "EnableGitDeployment": "[steps('deployment').gitConfig.enableGitDeployment]",
            "GitRepositoryUrl": "[if(steps('deployment').gitConfig.enableGitDeployment, steps('deployment').gitConfig.repositoryUrl, '')]",
            "GitBranch": "[if(steps('deployment').gitConfig.enableGitDeployment, steps('deployment').gitConfig.gitBranch, 'main')]"
        }
    }
}
