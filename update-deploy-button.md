# Update ARM Template for Deploy to Azure Button

This script updates the Azure Blob Storage with the latest ARM template for the "Deploy to Azure" button.

## Prerequisites

- Azure CLI installed and logged in
- Appropriate permissions to the storage account

## Usage

```bash
# Login to Azure if not already logged in
az login

# Set variables
STORAGE_ACCOUNT="stbtpukssandopenai"
CONTAINER_NAME="policing-assistant-azure-deployment-template"
TEMPLATE_FILE="infrastructure/deployment.json"
BLOB_NAME="deployment.json"

# Upload the template file
az storage blob upload \
  --account-name $STORAGE_ACCOUNT \
  --container-name $CONTAINER_NAME \
  --name $BLOB_NAME \
  --file $TEMPLATE_FILE \
  --auth-mode login \
  --overwrite

# Generate a SAS token with 1 year expiry
END_DATE=$(date -u -d "1 year" '+%Y-%m-%dT%H:%M:%SZ')
SAS_TOKEN=$(az storage blob generate-sas \
  --account-name $STORAGE_ACCOUNT \
  --container-name $CONTAINER_NAME \
  --name $BLOB_NAME \
  --permissions r \
  --expiry $END_DATE \
  --https-only \
  --output tsv)

# Generate the full URL
BLOB_URL=$(az storage blob url \
  --account-name $STORAGE_ACCOUNT \
  --container-name $CONTAINER_NAME \
  --name $BLOB_NAME \
  --output tsv)

# Print the full URL with SAS token
FULL_URL="${BLOB_URL}?${SAS_TOKEN}"
echo "Template URL with SAS token:"
echo $FULL_URL

# Print the encoded URL for the Deploy to Azure button
ENCODED_URL=$(echo $FULL_URL | jq -sRr @uri)
DEPLOY_BUTTON_URL="https://portal.azure.com/#create/Microsoft.Template/uri/${ENCODED_URL}"
echo "Deploy to Azure button URL:"
echo $DEPLOY_BUTTON_URL
```

## After updating

After updating the template in the blob storage, you'll need to update the URL in the README.md file:

```markdown
[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](YOUR_NEW_URL_HERE)
```

Replace `YOUR_NEW_URL_HERE` with the value of `DEPLOY_BUTTON_URL` generated by this script.
